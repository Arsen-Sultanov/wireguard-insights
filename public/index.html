<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Guard - insights</title>
</head>

<body class="">
    <div id="app">
        <div class="container mx-auto">
            <div class="container p-2 mx-auto sm:p-4 dark:text-gray-100">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-xs">
                        <colgroup>
                            <col>
                            <col>
                            <col>
                            <col>
                            <col class="w-16">
                        </colgroup>
                        <thead class="dark:bg-gray-700">
                            <tr class="text-left">
                                <th class="p-3">client</th>
                                <th class="p-3">peer</th>
                                <th class="p-3">endpoint</th>
                                <th class="p-3">allowed ips</th>
                                <th class="p-3">last TLS handshake</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">recieved</th>
                                <th class="p-3">sent</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(peer ,index) in peers"
                                class="border-b border-opacity-20 dark:border-gray-700 dark:bg-gray-900">
                                <template v-if="peer">
                                    <td class="p-3">
                                        <p>{{ String(peer.client) }}</p>
                                    </td>
                                    <td class="p-3">
                                        <p>{{ String(peer.publicKey).slice(0, 16) }}...</p>
                                    </td>
                                    <td class="p-3">
                                        <p>{{ peer.endpoint }}</p>
                                    </td>
                                    <td class="p-3">
                                        <p>{{ peer.allowedIps }}</p>
                                    </td>
                                    <td class="p-3">
                                        <p>{{ peer.lastTlsHandshake }}</p>
                                        <!-- <p class="dark:text-gray-400">Tuesday</p> -->
                                    </td>
                                    <td class="p-3">
                                        <p>{{ peer.status ? '✅' : '❌' }}</p>
                                        <!-- <p class="dark:text-gray-400">Tuesday</p> -->
                                    </td>
                                    <td class="p-3">
                                        <p>{{ peer.transfer.sent }}</p>
                                    </td>
                                    <td class="p-3">
                                        <span>{{ peer.transfer.recieved }}</span>
                                    </td>
                                </template>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>

</html>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script>
    const { createApp } = Vue
    createApp({
        data() {
            return {
                isLoading: false,
                isFetching: false,
                peers: [],
                polling: null,
            }
        },
        methods: {
            pollData: function () {
                this.polling = setInterval(() => {
                    if (!this.isFetching) { this.isFetching = true } else return;
                    fetch('/api/v1/clients').then(res => {
                        this.isFetching = false
                        return res.json()
                    }).then(({ data }) => this.peers = data)
                }, 300);
            }
        },
        beforeDestroy() {
            clearInterval(this.polling)
        },
        created() {
            if (!this.isFetching) { this.isFetching = true } else return;
            fetch('/api/v1/clients').then(res => {
                this.isFetching = false
                return res.json()
            }).then(({ data }) => this.peers = data)
            this.pollData()
        },
    }).mount('#app')
</script>